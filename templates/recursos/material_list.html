{% extends "base.html" %}
{% block title %}Materiales · Presupuesto{% endblock %}

{% block extra_css %}
<style>
    .filters th { padding-bottom: 6px; }
    .filters input, .filters select { font-size: 0.85rem; }
    .row-new { background: #f8fafc; }
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    input[type="number"] { -moz-appearance: textfield; }
</style>
{% endblock %}

{% block content %}
<main class="shell">
    <header>
        <div>
            <h1>Materiales</h1>
            <p>Hoja tipo Excel para editar y filtrar la lista de materiales.</p>
            {% if lote %}
            <a class="link link-back" href="{% url 'recursos:lote_detalle' lote.pk %}">← Volver al lote</a>
            {% else %}
            <a class="link link-back" href="{% url 'general:dashboard' %}">← Volver al panel</a>
            {% endif %}
        </div>
        <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
            {% if not modo_hoja %}
            <button class="btn btn-primary" type="button" onclick="mostrarFilaNuevo();">+ Nuevo material</button>
            {% else %}
            <a href="{% url 'recursos:material_list' %}?hoja={{ hoja_seleccionada.pk }}&agregar=1" class="btn btn-primary">+ Agregar material a hoja</a>
            {% endif %}
        </div>
    </header>

    <section class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; flex-wrap:wrap; gap:8px;">
            <small style="color:var(--text-muted);">Filtrá por cualquiera de las columnas escribiendo en la fila de filtros.</small>
            {% if hoja_seleccionada %}
            <small style="color:var(--accent);">Editando hoja «{{ hoja_seleccionada.nombre }}».</small>
            {% endif %}
        </div>

        <div style="overflow-x:auto;">
            <table id="tabla-materiales">
                    <thead>
                    <tr>
                        <th><input type="checkbox" id="select-all"></th>
                        <th>#</th>
                        <th>Nombre</th>
                        <th>Proveedor</th>
                        <th>Tipo</th>
                        <th>Categoría</th>
                        <th>Unidad venta</th>
                        <th class="num">Cant. por unidad</th>
                        <th class="num">Precio unidad venta</th>
                        <th class="num">UA (precio análisis)</th>
                        <th>Moneda</th>
                        <th></th>
                    </tr>
                    <tr class="filters">
                        <th></th>
                        <th></th>
                        <th><input type="text" data-col="2" placeholder="Filtrar nombre"></th>
                        <th><input type="text" data-col="3" placeholder="Filtrar proveedor"></th>
                        <th><input type="text" data-col="4" placeholder="Filtrar tipo"></th>
                        <th><input type="text" data-col="5" placeholder="Filtrar categoría"></th>
                        <th><input type="text" data-col="6" placeholder="Filtrar unidad"></th>
                        <th><input type="text" data-col="7" placeholder="Filtrar cant."></th>
                        <th><input type="text" data-col="8" placeholder="Filtrar precio"></th>
                        <th><input type="text" data-col="9" placeholder="Filtrar UA"></th>
                        <th><input type="text" data-col="10" placeholder="Filtrar moneda"></th>
                        <th></th>
                    </tr>
                    </thead>
                    <tbody>
                    {% if materiales %}
                        {% if modo_hoja %}
                            {% for detalle in materiales %}
                            <tr>
                                <td><input type="checkbox" name="selected_ids" value="{{ detalle.pk }}" form="bulk-form"></td>
                                <td>{{ forloop.counter }}</td>
                                {% if editing_hoja and editing_hoja.pk == detalle.pk %}
                                <form method="post" action="{% url 'recursos:hoja_detalle_edit' hoja_seleccionada.pk detalle.pk %}">
                                    {% csrf_token %}
                                    <td>{{ detalle.material.nombre }}</td>
                                    <td>{{ detalle.material.proveedor }}</td>
                                    <td>{{ detalle.material.tipo }}</td>
                                    <td>{{ detalle.material.categoria }}</td>
                                    <td>{{ detalle.material.unidad_de_venta }}</td>
                                    <td>{{ form_hoja_detalle.cantidad_por_unidad_venta }}</td>
                                    <td>{{ form_hoja_detalle.precio_unidad_venta }}</td>
                                    <td class="num">{{ detalle.precio_por_unidad_analisis|floatformat:2 }}</td>
                                    <td>{{ form_hoja_detalle.moneda }}</td>
                                    <td class="actions">
                                        <button type="submit" class="btn-link">Guardar</button> |
                                        <a href="{% url 'recursos:material_list' %}?hoja={{ hoja_seleccionada.pk }}" class="btn-link">Cancelar</a>
                                    </td>
                                </form>
                                {% else %}
                                <td>{{ detalle.material.nombre }}</td>
                                <td>{{ detalle.material.proveedor }}</td>
                                <td>{{ detalle.material.tipo }}</td>
                                <td>{{ detalle.material.categoria }}</td>
                                <td>{{ detalle.material.unidad_de_venta }}</td>
                                <td class="num">{{ detalle.cantidad_por_unidad_venta|floatformat:2 }}</td>
                                <td class="num">{{ detalle.precio_unidad_venta|floatformat:2 }}</td>
                                <td class="num">{{ detalle.precio_por_unidad_analisis|floatformat:2 }}</td>
                                <td>{{ detalle.moneda }}</td>
                                <td class="actions">
                                    <a href="{% url 'recursos:material_list' %}?hoja={{ hoja_seleccionada.pk }}&editar={{ detalle.pk }}" class="btn-link">Editar</a> |
                                    <form action="{% url 'recursos:hoja_detalle_delete' hoja_seleccionada.pk detalle.pk %}" method="post" style="display:inline">
                                        {% csrf_token %}
                                        <button type="submit" class="btn-link btn-danger" onclick="return confirm('¿Quitar este material de la hoja?');">Quitar</button>
                                    </form>
                                </td>
                                {% endif %}
                            </tr>
                            {% endfor %}
                        {% else %}
                            {% for material in materiales %}
                            <tr>
                                <td><input type="checkbox" name="selected_ids" value="{{ material.pk }}" form="bulk-form"></td>
                                <td>{{ forloop.counter }}</td>
                            {% if editing and editing.pk == material.pk %}
                                <form method="post" action="{% url 'recursos:material_edit' material.pk %}">
                                    {% csrf_token %}
                                    <td>{{ form_edit.nombre }}</td>
                                    <td>{{ form_edit.proveedor }}</td>
                                    <td>{{ form_edit.tipo }}</td>
                                    <td>{{ form_edit.categoria }}</td>
                                    <td>{{ form_edit.unidad_de_venta }}</td>
                                    <td>{{ form_edit.cantidad_por_unidad_venta }}</td>
                                    <td>{{ form_edit.precio_unidad_venta }}</td>
                                    <td class="num">{{ editing.precio_por_unidad_analisis|floatformat:2 }}</td>
                                    <td>{{ form_edit.moneda }}</td>
                                    <td class="actions">
                                        <button type="submit" class="btn-link">Guardar</button> |
                                        <a href="{% url 'recursos:material_list' %}">Cancelar</a>
                                    </td>
                                </form>
                            {% else %}
                                <td>{{ material.nombre }}</td>
                                <td>{{ material.proveedor }}</td>
                                <td>{{ material.tipo }}</td>
                                <td>{{ material.categoria }}</td>
                                <td>{{ material.unidad_de_venta }}</td>
                                <td class="num">{{ material.cantidad_por_unidad_venta|floatformat:2 }}</td>
                                <td class="num">{{ material.precio_unidad_venta|floatformat:2 }}</td>
                                <td class="num">{{ material.precio_por_unidad_analisis|floatformat:2 }}</td>
                                <td>{{ material.moneda }}</td>
                                <td class="actions">
                                    <a href="{% url 'recursos:material_edit' material.pk %}" class="btn-link">Editar</a> |
                                    <button type="submit" form="form-delete-{{ material.pk }}" class="btn-link btn-danger" onclick="return confirm('¿Eliminar este material?');">Eliminar</button>
                                </td>
                            {% endif %}
                            </tr>
                            {% endfor %}
                        {% endif %}
                    {% else %}
                        <tr>
                            <td colspan="12">No hay materiales cargados.</td>
                        </tr>
                    {% endif %}
                    </tbody>
                </table>

            <form method="post" action="{% url 'recursos:material_bulk_update' %}" id="bulk-form" style="margin-top:14px;">
                {% csrf_token %}
                {% if hoja_seleccionada %}
                <input type="hidden" name="hoja" value="{{ hoja_seleccionada.pk }}">
                {% endif %}
                <div style="display:flex; align-items:center; gap:8px; font-size:0.9rem;">
                    <span>Actualizar precios de seleccionados en un</span>
                    <input type="number" name="porcentaje" step="0.01" min="0" style="width:90px;" value="0.00">
                    <span>%</span>
                    <button type="submit" class="btn btn-primary" style="padding:6px 14px;">Actualizar precios</button>
                </div>
            </form>
        </div>

        {% if not modo_hoja and materiales %}
        <div style="display:none;" aria-hidden="true">
            {% for material in materiales %}
            <form id="form-delete-{{ material.pk }}" method="post" action="{% url 'recursos:material_delete' material.pk %}">
                {% csrf_token %}
            </form>
            {% endfor %}
        </div>
        {% endif %}

        {% if not modo_hoja %}
        <div id="card-nuevo-material" style="display:none; margin-top:12px;">
            <form method="post" action="{% url 'recursos:material_list' %}" id="form-nuevo-material" class="card">
                {% csrf_token %}
                <h3 style="margin:0 0 12px;">Nuevo material</h3>
                <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:12px;">
                    <div class="field"><label for="id_nombre">Nombre</label>{{ form_new.nombre }}</div>
                    <div class="field"><label for="id_proveedor">Proveedor</label>{{ form_new.proveedor }}</div>
                    <div class="field"><label for="id_tipo">Tipo</label>{{ form_new.tipo }}</div>
                    <div class="field"><label for="id_categoria">Categoría</label>{{ form_new.categoria }}</div>
                    <div class="field"><label for="id_unidad_de_venta">Unidad venta</label>{{ form_new.unidad_de_venta }}</div>
                    <div class="field"><label for="id_cantidad_por_unidad_venta">Cant. por unidad</label>{{ form_new.cantidad_por_unidad_venta }}</div>
                    <div class="field"><label for="id_precio_unidad_venta">Precio unidad</label>{{ form_new.precio_unidad_venta }}</div>
                    <div class="field"><label for="id_moneda">Moneda</label>{{ form_new.moneda }}</div>
                </div>
                <div style="margin-top:12px;"><button type="submit" class="btn btn-primary">Guardar</button> <button type="button" class="btn-link btn-danger" onclick="ocultarFilaNuevo();">Cancelar</button></div>
            </form>
        </div>
        {% endif %}
    </section>

    {% if modo_hoja and materiales_no_en_hoja is not None %}
    <section class="card" style="margin-top:16px;">
        <h3 style="margin:0 0 12px;">Agregar material a la hoja</h3>
        <p style="font-size:0.9rem; color:var(--text-muted); margin:0 0 12px;">Elegí un material para agregarlo a la hoja «{{ hoja_seleccionada.nombre }}»:</p>
        <form method="post" action="{% url 'recursos:material_list' %}?hoja={{ hoja_seleccionada.pk }}&agregar=1">
            {% csrf_token %}
            <table style="margin-bottom:12px;">
                <thead>
                <tr>
                    <th></th>
                    <th>Nombre</th>
                    <th>Proveedor</th>
                    <th>Tipo</th>
                    <th class="num">Precio actual</th>
                </tr>
                </thead>
                <tbody>
                {% for m in materiales_no_en_hoja %}
                <tr>
                    <td><input type="radio" name="material_id" value="{{ m.pk }}" required></td>
                    <td>{{ m.nombre }}</td>
                    <td>{{ m.proveedor }}</td>
                    <td>{{ m.tipo }}</td>
                    <td class="num">{{ m.precio_unidad_venta|floatformat:2 }}</td>
                </tr>
                {% empty %}
                <tr><td colspan="5">Todos los materiales ya están en la hoja.</td></tr>
                {% endfor %}
                </tbody>
            </table>
            {% if materiales_no_en_hoja %}
            <button type="submit" class="btn btn-primary">Agregar a la hoja</button>
            {% endif %}
            <a href="{% url 'recursos:material_list' %}?hoja={{ hoja_seleccionada.pk }}" class="btn-link" style="margin-left:8px;">Cancelar</a>
        </form>
    </section>
    {% endif %}
</main>

<script>
    (function () {
        var el = document.getElementById('hoja-select');
        if (el) el.addEventListener('change', function () {
            var base = "{% url 'recursos:material_list' %}";
            var pk = this.value;
            window.location = pk ? base + "?hoja=" + encodeURIComponent(pk) : base;
        });
    })();

    function mostrarFilaNuevo() {
        const card = document.getElementById('card-nuevo-material');
        if (card) {
            card.style.display = '';
            const inputNombre = card.querySelector('input[type="text"], select');
            if (inputNombre) inputNombre.focus();
            card.scrollIntoView({behavior: 'smooth', block: 'nearest'});
        }
    }

    function ocultarFilaNuevo() {
        const card = document.getElementById('card-nuevo-material');
        if (card) card.style.display = 'none';
    }

    const selectAll = document.getElementById('select-all');
    if (selectAll) {
        selectAll.addEventListener('change', function () {
            const checked = this.checked;
            document.querySelectorAll('#tabla-materiales tbody input[type="checkbox"][name="selected_ids"]').forEach(function (cb) {
                if (cb.closest('tr').style.display !== 'none') cb.checked = checked;
            });
        });
    }

    document.querySelectorAll('.filters input').forEach(function (input) {
        input.addEventListener('input', function () {
            const col = parseInt(this.getAttribute('data-col'), 10);
            const value = this.value.toLowerCase();
            document.querySelectorAll('#tabla-materiales tbody tr').forEach(function (row) {
                const cell = row.children[col];
                if (!cell) return;
                row.style.display = cell.textContent.toLowerCase().indexOf(value) !== -1 ? '' : 'none';
            });
        });
    });
</script>
{% endblock %}
